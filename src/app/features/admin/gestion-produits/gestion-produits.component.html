<div class="container-fluid mt-4">
  <h2 class="mb-4">Gestion des Œuvres</h2>

  <!-- Bouton Ajouter -->
  <div class="mb-3">
    <a [routerLink]="['/admin/create-oeuvre']" class="btn btn-primary">
      <i class="bi bi-plus-circle"></i> Ajouter une œuvre
    </a>
  </div>

  <!-- Filtres -->
  <div class="row mb-3">
    <div class="col-md-4">
      <input type="text"
             class="form-control"
             placeholder="Rechercher par titre, artiste..."
             [(ngModel)]="searchTerm"
             (ngModelChange)="filterOeuvres()">
    </div>
    <div class="col-md-3">
      <select class="form-select"
              [(ngModel)]="filterCategorie"
              (ngModelChange)="filterOeuvres()">
        <option value="">Toutes les catégories</option>
        <option *ngFor="let cat of categories()" [value]="cat.id">
          {{ cat.nom }}
        </option>
      </select>
    </div>
    <div class="col-md-5 text-end">
      <span class="me-3">{{ oeuvresFiltered().length }} œuvre(s)</span>
      <button class="btn btn-outline-primary" (click)="loadOeuvres()">
        <i class="bi bi-arrow-clockwise"></i> Actualiser
      </button>
    </div>
  </div>

  <!-- Loader -->
  <div *ngIf="loading()" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Chargement...</span>
    </div>
  </div>

  <!-- Tableau -->
  <div *ngIf="!loading()" class="table-responsive">
    <table class="table table-striped table-hover">
      <thead class="table-dark">
      <tr>
        <th>Image</th>
        <th>Titre</th>
        <th>Artiste</th>
        <th>Catégorie</th>
        <th>Prix</th>
        <th>Stock</th>
        <th>Statut</th>
        <th>Actions</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let oeuvre of oeuvresFiltered()">
        <td>
          <img [src]="(oeuvre.images && oeuvre.images.length > 0) ? oeuvre.images[0] : 'https://placehold.co/60x60/667eea/ffffff?text=Art'"
               [alt]="oeuvre.titre"
               class="img-thumbnail"
               style="width: 60px; height: 60px; object-fit: cover;">
        </td>
        <td>
          <strong>{{ oeuvre.titre }}</strong>
          <br>
          <small class="text-muted">{{ oeuvre.description | slice:0:50 }}...</small>
        </td>
        <td>{{ oeuvre.artisteNom || 'N/A' }}</td>
        <td>
          <!-- ✅ CORRECTION ICI -->
          <span *ngIf="oeuvre.categorie && oeuvre.categorie.length < 30"
                class="badge bg-info">
            {{ oeuvre.categorie }}
          </span>
          <span *ngIf="!oeuvre.categorie || oeuvre.categorie.length >= 30"
                class="badge bg-secondary">
            Non catégorisé
          </span>
        </td>
        <td>{{ oeuvre.prix }} DT</td>
        <td>
          <span [ngClass]="{
            'text-success': (oeuvre.stockDisponible || oeuvre.quantiteDisponible || 0) > 10,
            'text-warning': (oeuvre.stockDisponible || oeuvre.quantiteDisponible || 0) > 0 && (oeuvre.stockDisponible || oeuvre.quantiteDisponible || 0) <= 10,
            'text-danger': (oeuvre.stockDisponible || oeuvre.quantiteDisponible || 0) === 0
          }">
            {{ oeuvre.stockDisponible || oeuvre.quantiteDisponible || 0 }}
          </span>
        </td>
        <td>
          <span class="badge"
                [ngClass]="{
                  'bg-success': oeuvre.statut === 'PUBLIE',
                  'bg-warning': oeuvre.statut === 'BROUILLON',
                  'bg-danger': oeuvre.statut === 'ARCHIVE'
                }">
            {{ oeuvre.statut || 'PUBLIE' }}
          </span>
        </td>
        <td>
          <div class="btn-group" role="group">
            <!-- ✅ BOUTON MODIFIER -->
            <button class="btn btn-sm btn-warning"
                    [routerLink]="['/admin/oeuvres/edit', oeuvre.id]"
                    title="Modifier">
              <i class="bi bi-pencil"></i>
            </button>

            <!-- Bouton Supprimer -->
            <button class="btn btn-sm btn-danger"
                    (click)="deleteOeuvre(oeuvre.id)"
                    title="Supprimer">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </td>
      </tr>
      </tbody>
    </table>

    <div *ngIf="oeuvresFiltered().length === 0" class="text-center py-4">
      <p class="text-muted">Aucune œuvre trouvée</p>
    </div>
  </div>
</div>
