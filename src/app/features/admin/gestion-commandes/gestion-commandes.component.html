<app-navbar />

<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col-12">
      <h2>üì¶ Gestion des commandes</h2>
    </div>
  </div>

  <!-- Filtres -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <input type="text" class="form-control" placeholder="üîç Rechercher par client ou ID..."
                 [(ngModel)]="searchTerm" (ngModelChange)="searchTerm.set($event)">
        </div>
        <div class="col-md-6">
          <select class="form-select" [(ngModel)]="filtreStatut"
                  (ngModelChange)="filtreStatut.set($event)">
            <option value="">Tous les statuts</option>
            <option value="EN_ATTENTE">En attente</option>
            <option value="CONFIRMEE">Confirm√©e</option>
            <option value="EN_PREPARATION">En pr√©paration</option>
            <option value="EXPEDIE">Exp√©di√©e</option>
            <option value="LIVREE">Livr√©e</option>
            <option value="ANNULEE">Annul√©e</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Tableau -->
  <div class="card">
    <div class="card-body">
      <div *ngIf="loading()" class="text-center py-5">
        <div class="spinner-border text-primary"></div>
      </div>

      <div *ngIf="!loading()" class="table-responsive">
        <table class="table table-hover">
          <thead>
          <tr>
            <th>ID</th>
            <th>Client</th>
            <th>Date</th>
            <th>Montant</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let commande of commandesFiltered()">
            <td>
              <code>{{ commande.id.substring(0, 8) }}...</code>
            </td>
            <td>
              <strong>{{ commande.clientNom }}</strong>
            </td>
            <td>{{ formatDate(commande.dateCommande) }}</td>
            <td class="fw-bold">{{ commande.montantTotal }} DT</td>
            <td>
                <span class="badge" [class]="getStatutBadge(commande.statut)">
                  {{ getStatutLabel(commande.statut) }}
                </span>
            </td>
            <td>
              <button class="btn btn-sm btn-outline-primary"
                      (click)="viewDetails(commande)">
                üëÅÔ∏è D√©tails
              </button>
            </td>
          </tr>
          </tbody>
        </table>

        <div *ngIf="commandesFiltered().length === 0" class="text-center py-5 text-muted">
          Aucune commande trouv√©e
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal D√©tails -->
<div class="modal" [class.show]="showDetailModal()" [style.display]="showDetailModal() ? 'block' : 'none'">
  <div class="modal-dialog modal-xl">
    <div class="modal-content" *ngIf="selectedCommande()">
      <div class="modal-header">
        <h5 class="modal-title">üì¶ Commande #{{ selectedCommande()!.id.substring(0, 8) }}</h5>
        <button type="button" class="btn-close" (click)="closeDetailModal()"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <h6>Informations client</h6>
            <p class="mb-1"><strong>Nom:</strong> {{ selectedCommande()!.clientNom }}</p>
            <p class="mb-1"><strong>ID Client:</strong>
              <code>{{ selectedCommande()!.clientId }}</code>
            </p>

            <h6 class="mt-3">Adresse de livraison</h6>
            <p class="mb-0">
              {{ selectedCommande()!.adresseLivraison.rue }}<br>
              {{ selectedCommande()!.adresseLivraison.ville }},
              {{ selectedCommande()!.adresseLivraison.codePostal }}<br>
              {{ selectedCommande()!.adresseLivraison.pays }}
            </p>
          </div>

          <div class="col-md-6">
            <h6>Informations commande</h6>
            <p class="mb-1"><strong>Date:</strong> {{ formatDate(selectedCommande()!.dateCommande) }}</p>
            <p class="mb-1"><strong>Statut:</strong>
              <span class="badge" [class]="getStatutBadge(selectedCommande()!.statut)">
                {{ getStatutLabel(selectedCommande()!.statut) }}
              </span>
            </p>
            <p class="mb-1"><strong>Montant total:</strong>
              <span class="text-primary fw-bold">{{ selectedCommande()!.montantTotal }} DT</span>
            </p>
          </div>
        </div>

        <hr>

        <h6>Produits command√©s</h6>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
            <tr>
              <th>Produit</th>
              <th class="text-center">Quantit√©</th>
              <th class="text-end">Prix unitaire</th>
              <th class="text-end">Total</th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let produit of selectedCommande()!.produits">
              <td>{{ produit.titre }}</td>
              <td class="text-center">{{ produit.quantite }}</td>
              <td class="text-end">{{ produit.prix }} DT</td>
              <td class="text-end fw-bold">{{ produit.prix * produit.quantite }} DT</td>
            </tr>
            </tbody>
            <tfoot>
            <tr>
              <td colspan="3" class="text-end"><strong>Total:</strong></td>
              <td class="text-end fw-bold text-primary">
                {{ selectedCommande()!.montantTotal }} DT
              </td>
            </tr>
            </tfoot>
          </table>
        </div>

        <hr>

        <h6>Changer le statut</h6>
        <div class="btn-group" role="group">
          <button *ngFor="let statut of getProchainStatuts(selectedCommande()!.statut)"
                  class="btn btn-outline-primary"
                  (click)="changerStatut(selectedCommande()!.id, statut)">
            {{ getStatutLabel(statut) }}
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeDetailModal()">Fermer</button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop" *ngIf="showDetailModal()" (click)="closeDetailModal()"></div>
