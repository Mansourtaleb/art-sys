<app-navbar></app-navbar>

<div class="container mt-4 mb-5">
  <h2 class="mb-4">Finaliser la commande</h2>

  <!-- Progress Steps -->
  <div class="row mb-4">
    <div class="col">
      <div class="progress" style="height: 30px;">
        <div class="progress-bar"
             [style.width.%]="etapeActuelle() * 33.33"
             role="progressbar">
          Étape {{ etapeActuelle() }} sur 3
        </div>
      </div>
    </div>
  </div>

  <!-- Erreur -->
  <div *ngIf="error()" class="alert alert-danger alert-dismissible fade show">
    {{ error() }}
    <button type="button" class="btn-close" (click)="error.set(null)"></button>
  </div>

  <div class="row">
    <!-- Récapitulatif panier (toujours visible) -->
    <div class="col-md-4 order-md-2">
      <div class="card mb-3">
        <div class="card-header">
          <h5>Récapitulatif</h5>
        </div>
        <div class="card-body">
          <div *ngFor="let item of items()" class="d-flex justify-content-between mb-2">
            <div>
              <p class="mb-0">{{ item.titre }}</p>
              <small class="text-muted">Qté: {{ item.quantite }}</small>
            </div>
            <div class="text-end">
              <strong>{{ item.prix * item.quantite }} DT</strong>
            </div>
          </div>

          <hr>

          <div class="d-flex justify-content-between">
            <span>Sous-total:</span>
            <span>{{ total() }} DT</span>
          </div>

          <div class="d-flex justify-content-between">
            <span>Frais de livraison:</span>
            <span>{{ fraisLivraison() }} DT</span>
          </div>

          <hr>

          <div class="d-flex justify-content-between">
            <strong>Total:</strong>
            <strong class="text-primary">{{ totalFinal() }} DT</strong>
          </div>
        </div>
      </div>
    </div>

    <!-- Contenu principal selon l'étape -->
    <div class="col-md-8 order-md-1">
      <!-- Étape 1: Adresse de livraison -->
      <div *ngIf="etapeActuelle() === 1" class="card">
        <div class="card-header">
          <h5>Adresse de livraison</h5>
        </div>
        <div class="card-body">
          <!-- Adresses existantes -->
          <div *ngIf="adresses().length > 0 && !modeNouvelleAdresse()">
            <h6>Sélectionner une adresse</h6>
            <div class="list-group mb-3">
              <label *ngFor="let adresse of adresses()"
                     class="list-group-item list-group-item-action">
                <input type="radio"
                       class="form-check-input me-2"
                       name="adresse"
                       (change)="selectAdresse(adresse)">
                <div>
                  <strong>{{ adresse.rue }}</strong><br>
                  {{ adresse.ville }}, {{ adresse.codePostal }}<br>
                  {{ adresse.pays }}
                  <span *ngIf="adresse.parDefaut" class="badge bg-primary ms-2">
                    Par défaut
                  </span>
                </div>
              </label>
            </div>
            <button class="btn btn-outline-primary" (click)="toggleNouvelleAdresse()">
              <i class="bi bi-plus-circle"></i> Nouvelle adresse
            </button>
          </div>

          <!-- Nouvelle adresse -->
          <div *ngIf="modeNouvelleAdresse() || adresses().length === 0">
            <h6>Nouvelle adresse</h6>
            <form>
              <div class="mb-3">
                <label class="form-label">Rue *</label>
                <input type="text"
                       class="form-control"
                       [(ngModel)]="nouvelleAdresse().rue"
                       name="rue"
                       required>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Ville *</label>
                    <select class="form-select"
                            [(ngModel)]="nouvelleAdresse().ville"
                            name="ville"
                            (change)="calculerFraisLivraison()"
                            required>
                      <option value="">Sélectionner</option>
                      <option value="Tunis">Tunis</option>
                      <option value="Ariana">Ariana</option>
                      <option value="Ben Arous">Ben Arous</option>
                      <option value="Manouba">Manouba</option>
                      <option value="Nabeul">Nabeul</option>
                      <option value="Sousse">Sousse</option>
                      <option value="Sfax">Sfax</option>
                      <option value="Autres">Autres</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Code Postal *</label>
                    <input type="text"
                           class="form-control"
                           [(ngModel)]="nouvelleAdresse().codePostal"
                           name="codePostal"
                           required>
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Pays</label>
                <input type="text"
                       class="form-control"
                       [(ngModel)]="nouvelleAdresse().pays"
                       name="pays"
                       readonly>
              </div>

              <div class="form-check mb-3">
                <input type="checkbox"
                       class="form-check-input"
                       [(ngModel)]="nouvelleAdresse().parDefaut"
                       name="parDefaut"
                       id="parDefaut">
                <label class="form-check-label" for="parDefaut">
                  Définir comme adresse par défaut
                </label>
              </div>

              <button *ngIf="adresses().length > 0"
                      type="button"
                      class="btn btn-secondary"
                      (click)="toggleNouvelleAdresse()">
                Annuler
              </button>
            </form>
          </div>
        </div>
        <div class="card-footer">
          <button class="btn btn-primary float-end"
                  (click)="nextStep()"
                  [disabled]="!adresseSelectionnee() && (!nouvelleAdresse().rue || !nouvelleAdresse().ville)">
            Suivant <i class="bi bi-arrow-right"></i>
          </button>
        </div>
      </div>

      <!-- Étape 2: Mode de paiement -->
      <div *ngIf="etapeActuelle() === 2" class="card">
        <div class="card-header">
          <h5>Mode de paiement</h5>
        </div>
        <div class="card-body">
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            Le paiement se fera à la livraison
          </div>

          <div class="form-check">
            <input class="form-check-input"
                   type="radio"
                   name="paiement"
                   id="cash"
                   checked>
            <label class="form-check-label" for="cash">
              <i class="bi bi-cash"></i> Paiement en espèces à la livraison
            </label>
          </div>
        </div>
        <div class="card-footer">
          <button class="btn btn-secondary" (click)="previousStep()">
            <i class="bi bi-arrow-left"></i> Retour
          </button>
          <button class="btn btn-primary float-end" (click)="nextStep()">
            Suivant <i class="bi bi-arrow-right"></i>
          </button>
        </div>
      </div>

      <!-- Étape 3: Confirmation -->
      <div *ngIf="etapeActuelle() === 3" class="card">
        <div class="card-header">
          <h5>Confirmation de la commande</h5>
        </div>
        <div class="card-body">
          <h6>Adresse de livraison</h6>
          <div class="mb-3 p-3 bg-light rounded">
            <div *ngIf="adresseSelectionnee()">
              {{ adresseSelectionnee()!.rue }}<br>
              {{ adresseSelectionnee()!.ville }}, {{ adresseSelectionnee()!.codePostal }}<br>
              {{ adresseSelectionnee()!.pays }}
            </div>
            <div *ngIf="!adresseSelectionnee() && nouvelleAdresse()">
              {{ nouvelleAdresse().rue }}<br>
              {{ nouvelleAdresse().ville }}, {{ nouvelleAdresse().codePostal }}<br>
              {{ nouvelleAdresse().pays }}
            </div>
          </div>

          <h6>Mode de paiement</h6>
          <p>Paiement en espèces à la livraison</p>

          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="cgv" required>
            <label class="form-check-label" for="cgv">
              J'accepte les conditions générales de vente
            </label>
          </div>
        </div>
        <div class="card-footer">
          <button class="btn btn-secondary" (click)="previousStep()">
            <i class="bi bi-arrow-left"></i> Retour
          </button>
          <button class="btn btn-success float-end"
                  (click)="passerCommande()"
                  [disabled]="loading()">
            <span *ngIf="!loading()">
              <i class="bi bi-check-circle"></i> Confirmer la commande
            </span>
            <span *ngIf="loading()">
              <span class="spinner-border spinner-border-sm me-2"></span>
              Traitement...
            </span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<app-footer></app-footer>




